<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NorthScrape Leads Dashboard</title>

    <!-- Tailwind CSS for Styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        slate: {
                            850: '#1e293b',
                            900: '#0f172a',
                            950: '#020617',
                        }
                    }
                }
            }
        }
    </script>

    <!-- PapaParse for reading CSV files -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>

    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        .glass-panel {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(229, 231, 235, 0.5);
        }
        .dark .glass-panel {
            background: rgba(30, 41, 59, 0.95);
            border: 1px solid rgba(71, 85, 105, 0.5);
        }

        /* Checkbox custom style */
        .custom-checkbox {
            appearance: none;
            background-color: #fff;
            margin: 0;
            font: inherit;
            color: currentColor;
            width: 1.25em;
            height: 1.25em;
            border: 2px solid #cbd5e1;
            border-radius: 0.25em;
            display: grid;
            place-content: center;
            cursor: pointer;
        }
        .dark .custom-checkbox {
            background-color: #1e293b;
            border-color: #475569;
        }
        .custom-checkbox::before {
            content: "";
            width: 0.65em;
            height: 0.65em;
            transform: scale(0);
            transition: 120ms transform ease-in-out;
            box-shadow: inset 1em 1em white;
            transform-origin: center;
            clip-path: polygon(14% 44%, 0 65%, 50% 100%, 100% 16%, 80% 0%, 43% 62%);
            background-color: #3b82f6;
        }
        .custom-checkbox:checked {
            background-color: #3b82f6;
            border-color: #3b82f6;
        }
        .custom-checkbox:checked::before {
            transform: scale(1);
            background-color: white;
        }

        /* Transitions */
        body, .bg-white, .bg-slate-50, .bg-slate-100, .bg-slate-900, .bg-slate-800, tr {
            transition: background-color 0.3s ease, color 0.3s ease, border-color 0.3s ease;
        }
    </style>
</head>
<body class="bg-slate-100 dark:bg-slate-950 text-slate-800 dark:text-slate-100 min-h-screen font-sans transition-colors duration-300">

    <!-- Top Navigation -->
    <nav class="bg-blue-900 dark:bg-slate-900 text-white shadow-lg sticky top-0 z-50 transition-colors duration-300">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex items-center justify-between h-16">
                <div class="flex items-center gap-3">
                    <i data-lucide="candycane" class="h-6 w-6 text-pink-400"></i>
                    <span class="font-bold text-xl tracking-tight hidden sm:block">NorthScrape Dashboard</span>
                    <span class="font-bold text-xl tracking-tight sm:hidden">NorthScrape</span>
                </div>
                <div class="flex items-center gap-4">
                    <div class="text-sm text-blue-200 hidden md:block">
                        Targeting: Northern Ontario
                    </div>
                    <!-- Dark Mode Toggle -->
                    <button id="theme-toggle" class="p-2 rounded-lg bg-blue-800 dark:bg-slate-800 hover:bg-blue-700 dark:hover:bg-slate-700 transition-colors">
                        <i data-lucide="moon" id="theme-icon" class="h-5 w-5 text-yellow-300"></i>
                    </button>
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">

        <!-- Stats Row -->
        <div id="stats-container" class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8 hidden">
            <div class="glass-panel p-6 rounded-xl shadow-sm border-l-4 border-blue-500">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm font-medium text-slate-500 dark:text-slate-400">Total Leads</p>
                        <p class="text-3xl font-bold text-slate-800 dark:text-white" id="stat-total">0</p>
                    </div>
                    <div class="p-3 bg-blue-100 dark:bg-blue-900/30 rounded-full text-blue-600 dark:text-blue-400">
                        <i data-lucide="users"></i>
                    </div>
                </div>
            </div>

            <div class="glass-panel p-6 rounded-xl shadow-sm border-l-4 border-green-500">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm font-medium text-slate-500 dark:text-slate-400">With Phone Numbers</p>
                        <p class="text-3xl font-bold text-slate-800 dark:text-white" id="stat-phones">0</p>
                    </div>
                    <div class="p-3 bg-green-100 dark:bg-green-900/30 rounded-full text-green-600 dark:text-green-400">
                        <i data-lucide="phone"></i>
                    </div>
                </div>
            </div>

            <div class="glass-panel p-6 rounded-xl shadow-sm border-l-4 border-purple-500">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm font-medium text-slate-500 dark:text-slate-400">Pending Calls</p>
                        <p class="text-3xl font-bold text-slate-800 dark:text-white" id="stat-pending">0</p>
                    </div>
                    <div class="p-3 bg-purple-100 dark:bg-purple-900/30 rounded-full text-purple-600 dark:text-purple-400">
                        <i data-lucide="list-todo"></i>
                    </div>
                </div>
            </div>
        </div>

        <!-- Drop Zone (Visible initially) -->
        <div id="drop-zone" class="border-4 border-dashed border-slate-300 dark:border-slate-700 rounded-2xl p-12 text-center hover:border-blue-500 hover:bg-blue-50 dark:hover:bg-slate-800 transition-colors cursor-pointer mb-8">
            <i data-lucide="upload-cloud" class="h-16 w-16 mx-auto text-slate-400 mb-4"></i>
            <h3 class="text-xl font-semibold text-slate-700 dark:text-slate-200">Load your Leads</h3>
            <p class="text-slate-500 dark:text-slate-400 mt-2">Drag and drop your exported <strong>.csv</strong> file here</p>
            <p class="text-sm text-slate-400 dark:text-slate-500 mt-4">(Or rename your file to <code>leads.csv</code> and host it with this page for auto-loading)</p>
            <input type="file" id="file-input" class="hidden" accept=".csv">
            <button onclick="document.getElementById('file-input').click()" class="mt-6 px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition">Select File</button>
        </div>

        <!-- Controls & Table (Hidden initially) -->
        <div id="data-container" class="hidden animate-fade-in">

            <!-- Controls Bar -->
            <div class="flex flex-col md:flex-row gap-4 mb-6">
                <!-- Search -->
                <div class="relative flex-grow">
                    <i data-lucide="search" class="absolute left-3 top-3 h-5 w-5 text-slate-400"></i>
                    <input type="text" id="search-input" placeholder="Search by name, city, or phone..."
                           class="w-full pl-10 pr-4 py-2 rounded-lg border border-slate-300 dark:border-slate-700 bg-white dark:bg-slate-800 text-slate-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent shadow-sm">
                </div>

                <!-- Filters -->
                <div class="flex flex-wrap gap-3 items-center">
                    <label class="flex items-center gap-2 cursor-pointer bg-white dark:bg-slate-800 border border-slate-300 dark:border-slate-700 px-4 py-2 rounded-lg hover:bg-slate-50 dark:hover:bg-slate-700 transition">
                        <input type="checkbox" id="filter-phones" class="w-4 h-4 text-blue-600 rounded focus:ring-blue-500">
                        <span class="text-sm font-medium text-slate-700 dark:text-slate-200">Has Phone Only</span>
                    </label>

                    <label class="flex items-center gap-2 cursor-pointer bg-white dark:bg-slate-800 border border-slate-300 dark:border-slate-700 px-4 py-2 rounded-lg hover:bg-slate-50 dark:hover:bg-slate-700 transition">
                        <input type="checkbox" id="filter-uncontacted" class="w-4 h-4 text-blue-600 rounded focus:ring-blue-500">
                        <span class="text-sm font-medium text-slate-700 dark:text-slate-200">Uncontacted Only</span>
                    </label>

                    <button onclick="clearFilters()" class="px-4 py-2 bg-white dark:bg-slate-800 border border-slate-300 dark:border-slate-700 rounded-lg text-slate-600 dark:text-slate-300 hover:bg-slate-50 dark:hover:bg-slate-700 text-sm font-medium">Reset</button>

                    <button onclick="exportFiltered()" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 text-sm font-medium flex items-center gap-2">
                        <i data-lucide="download" class="h-4 w-4"></i> <span class="hidden sm:inline">Export</span>
                    </button>
                </div>
            </div>

            <!-- Table -->
            <div class="bg-white dark:bg-slate-800 rounded-xl shadow-lg overflow-hidden border border-slate-200 dark:border-slate-700 transition-colors">
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-slate-200 dark:divide-slate-700">
                        <thead class="bg-slate-50 dark:bg-slate-900">
                            <tr>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-bold text-slate-500 dark:text-slate-400 uppercase tracking-wider w-16">Called?</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-bold text-slate-500 dark:text-slate-400 uppercase tracking-wider">Business Name</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-bold text-slate-500 dark:text-slate-400 uppercase tracking-wider">Location</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-bold text-slate-500 dark:text-slate-400 uppercase tracking-wider">Phone</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-bold text-slate-500 dark:text-slate-400 uppercase tracking-wider">Action</th>
                            </tr>
                        </thead>
                        <tbody id="table-body" class="bg-white dark:bg-slate-800 divide-y divide-slate-200 dark:divide-slate-700">
                            <!-- Rows inserted via JS -->
                        </tbody>
                    </table>
                </div>

                <div id="no-results" class="hidden p-8 text-center text-slate-500 dark:text-slate-400">
                    No matching clients found.
                </div>

                <!-- Pagination Footer -->
                <div class="bg-slate-50 dark:bg-slate-900 px-6 py-4 border-t border-slate-200 dark:border-slate-700 flex flex-col sm:flex-row items-center justify-between gap-4">
                    <span id="showing-count" class="text-sm text-slate-500 dark:text-slate-400">Showing 0 results</span>

                    <div class="flex items-center gap-4">
                        <span class="text-sm text-slate-500 dark:text-slate-400">
                            Page <span id="current-page-display" class="font-bold text-slate-700 dark:text-slate-200">1</span> of <span id="total-pages-display" class="font-bold text-slate-700 dark:text-slate-200">1</span>
                        </span>
                        <div class="flex gap-2">
                            <button id="btn-prev" onclick="changePage(-1)" disabled class="px-3 py-1 bg-white dark:bg-slate-800 border border-slate-300 dark:border-slate-700 rounded hover:bg-slate-100 dark:hover:bg-slate-700 disabled:opacity-50 disabled:cursor-not-allowed text-sm font-medium text-slate-600 dark:text-slate-300">Previous</button>
                            <button id="btn-next" onclick="changePage(1)" disabled class="px-3 py-1 bg-white dark:bg-slate-800 border border-slate-300 dark:border-slate-700 rounded hover:bg-slate-100 dark:hover:bg-slate-700 disabled:opacity-50 disabled:cursor-not-allowed text-sm font-medium text-slate-600 dark:text-slate-300">Next</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <script>
        // --- State ---
        let allData = [];
        let filteredData = [];
        let currentPage = 1;
        const rowsPerPage = 50;

        // --- Dark Mode Logic ---
        const themeToggleBtn = document.getElementById('theme-toggle');
        const themeIcon = document.getElementById('theme-icon');

        // Check local storage or system preference
        if (localStorage.theme === 'dark' || (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
            document.documentElement.classList.add('dark');
            themeIcon.setAttribute('data-lucide', 'sun');
        } else {
            document.documentElement.classList.remove('dark');
            themeIcon.setAttribute('data-lucide', 'moon');
        }

        themeToggleBtn.addEventListener('click', () => {
            if (document.documentElement.classList.contains('dark')) {
                document.documentElement.classList.remove('dark');
                localStorage.theme = 'light';
                themeIcon.setAttribute('data-lucide', 'moon');
            } else {
                document.documentElement.classList.add('dark');
                localStorage.theme = 'dark';
                themeIcon.setAttribute('data-lucide', 'sun');
            }
            lucide.createIcons();
        });

        // --- Init ---
        lucide.createIcons();

        // Check for auto-load file
        fetch('leads.csv').then(response => {
            if (response.ok) {
                response.text().then(csvText => {
                    parseCSV(csvText);
                });
            }
        }).catch(() => console.log("No auto-load file found"));

        // --- Event Listeners ---
        const dropZone = document.getElementById('drop-zone');
        const fileInput = document.getElementById('file-input');
        const searchInput = document.getElementById('search-input');
        const filterPhones = document.getElementById('filter-phones');
        const filterUncontacted = document.getElementById('filter-uncontacted');

        dropZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            dropZone.classList.add('border-blue-500', 'bg-blue-50', 'dark:bg-slate-800');
        });

        dropZone.addEventListener('dragleave', (e) => {
            e.preventDefault();
            dropZone.classList.remove('border-blue-500', 'bg-blue-50', 'dark:bg-slate-800');
        });

        dropZone.addEventListener('drop', (e) => {
            e.preventDefault();
            dropZone.classList.remove('border-blue-500', 'bg-blue-50', 'dark:bg-slate-800');
            const file = e.dataTransfer.files[0];
            if (file) handleFile(file);
        });

        fileInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) handleFile(file);
        });

        searchInput.addEventListener('input', runFilters);
        filterPhones.addEventListener('change', runFilters);
        filterUncontacted.addEventListener('change', runFilters);

        // --- Logic ---

        function handleFile(file) {
            Papa.parse(file, {
                header: true,
                skipEmptyLines: true,
                complete: function(results) {
                    const headers = results.meta.fields;
                    if (!headers.includes("Name") && !headers.includes("Address")) {
                        alert("Invalid CSV format. Please use the export from NorthScrape.");
                        return;
                    }
                    // Generate unique IDs for local storage tracking if not present
                    allData = results.data.map((row, index) => ({
                        ...row,
                        id: btoa(unescape(encodeURIComponent((row.Name || '') + (row.Address || '')))).substring(0, 16)
                    }));
                    initDashboard();
                }
            });
        }

        function parseCSV(csvText) {
            const results = Papa.parse(csvText, {
                header: true,
                skipEmptyLines: true
            });
            allData = results.data.map((row) => ({
                ...row,
                id: btoa(unescape(encodeURIComponent((row.Name || '') + (row.Address || '')))).substring(0, 16)
            }));
            initDashboard();
        }

        function initDashboard() {
            document.getElementById('drop-zone').classList.add('hidden');
            document.getElementById('stats-container').classList.remove('hidden');
            document.getElementById('stats-container').classList.add('grid');
            document.getElementById('data-container').classList.remove('hidden');

            updateStats();
            runFilters();
        }

        function updateStats() {
            const total = allData.length;
            const withPhones = allData.filter(d => d.Phone && d.Phone !== 'N/A' && d.Phone !== '').length;

            // Calculate pending (unchecked items in local storage)
            const contacted = getContactedList();
            const pending = total - allData.filter(d => contacted.includes(d.id)).length;

            document.getElementById('stat-total').innerText = total;
            document.getElementById('stat-phones').innerText = withPhones;
            document.getElementById('stat-pending').innerText = pending;
        }

        function getContactedList() {
            const stored = localStorage.getItem('contacted_leads');
            return stored ? JSON.parse(stored) : [];
        }

        function toggleContacted(id) {
            let contacted = getContactedList();
            if (contacted.includes(id)) {
                contacted = contacted.filter(i => i !== id);
            } else {
                contacted.push(id);
            }
            localStorage.setItem('contacted_leads', JSON.stringify(contacted));
            updateStats();
            // Re-render only if filtering by uncontacted, otherwise just update row style
            if (filterUncontacted.checked) {
                runFilters();
            } else {
                renderTable(); // Simple re-render to update checkbox visuals
            }
        }

        function runFilters() {
            const query = searchInput.value.toLowerCase();
            const phonesOnly = filterPhones.checked;
            const uncontactedOnly = filterUncontacted.checked;
            const contactedList = getContactedList();

            filteredData = allData.filter(row => {
                // Text Search
                const name = (row.Name || '').toLowerCase();
                const address = (row.Address || '').toLowerCase();
                const phone = (row.Phone || '').toLowerCase();
                const matchesText = name.includes(query) || address.includes(query) || phone.includes(query);

                // Phone Filter
                const hasPhone = row.Phone && row.Phone !== 'N/A' && row.Phone !== '';
                const matchesPhone = !phonesOnly || hasPhone;

                // Uncontacted Filter
                const isContacted = contactedList.includes(row.id);
                const matchesContacted = !uncontactedOnly || !isContacted;

                return matchesText && matchesPhone && matchesContacted;
            });

            currentPage = 1;
            renderTable();
        }

        function clearFilters() {
            searchInput.value = '';
            filterPhones.checked = false;
            filterUncontacted.checked = false;
            runFilters();
        }

        function changePage(direction) {
            const totalPages = Math.ceil(filteredData.length / rowsPerPage);
            const newPage = currentPage + direction;
            if (newPage > 0 && newPage <= totalPages) {
                currentPage = newPage;
                renderTable();
            }
        }

        function renderTable() {
            const tbody = document.getElementById('table-body');
            tbody.innerHTML = '';

            const contactedList = getContactedList();

            const totalRows = filteredData.length;
            const totalPages = Math.ceil(totalRows / rowsPerPage) || 1;

            if (totalRows === 0) {
                document.getElementById('no-results').classList.remove('hidden');
                document.getElementById('showing-count').innerText = "Showing 0 results";
            } else {
                document.getElementById('no-results').classList.add('hidden');
            }

            const startIndex = (currentPage - 1) * rowsPerPage;
            const endIndex = Math.min(startIndex + rowsPerPage, totalRows);
            const pageData = filteredData.slice(startIndex, endIndex);

            if (totalRows > 0) {
                document.getElementById('showing-count').innerText = `Showing ${startIndex + 1} to ${endIndex} of ${totalRows} results`;
            } else {
                document.getElementById('showing-count').innerText = `Showing 0 results`;
            }

            document.getElementById('current-page-display').innerText = currentPage;
            document.getElementById('total-pages-display').innerText = totalPages;

            document.getElementById('btn-prev').disabled = currentPage === 1;
            document.getElementById('btn-next').disabled = currentPage === totalPages || totalRows === 0;

            pageData.forEach(row => {
                const tr = document.createElement('tr');
                const isContacted = contactedList.includes(row.id);

                // Style adjustment for contacted rows
                if (isContacted) {
                    tr.classList.add('opacity-50', 'bg-slate-50', 'dark:bg-slate-800/50');
                }
                tr.className += " border-b border-slate-200 dark:border-slate-700 hover:bg-slate-50 dark:hover:bg-slate-700/50 transition-colors";

                // Checkbox
                const checkboxCell = `<td class="px-6 py-4">
                    <input type="checkbox" class="custom-checkbox"
                           ${isContacted ? 'checked' : ''}
                           onclick="toggleContacted('${row.id}')">
                </td>`;

                // Name
                const nameCell = `<td class="px-6 py-4 whitespace-nowrap">
                    <div class="text-sm font-bold text-slate-900 dark:text-white ${isContacted ? 'line-through decoration-slate-400' : ''}">${row.Name || 'Unknown'}</div>
                    ${row.Website && row.Website !== 'N/A' ?
                        `<a href="${row.Website}" target="_blank" class="text-xs text-blue-500 hover:underline flex items-center gap-1 mt-1">
                           Visit Website <i data-lucide="external-link" class="h-3 w-3"></i>
                        </a>` : ''}
                </td>`;

                // Address
                const addressCell = `<td class="px-6 py-4">
                    <div class="text-sm text-slate-600 dark:text-slate-400 max-w-xs truncate" title="${row.Address}">${row.Address || 'N/A'}</div>
                </td>`;

                // Phone
                const hasPhone = row.Phone && row.Phone !== 'N/A' && row.Phone !== '';
                const phoneCell = `<td class="px-6 py-4 whitespace-nowrap">
                    ${hasPhone ?
                        `<a href="tel:${row.Phone}" class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800 hover:bg-green-200 dark:bg-green-900 dark:text-green-200 dark:hover:bg-green-800 transition-colors">
                           <i data-lucide="phone" class="h-3 w-3 mr-1"></i> ${row.Phone}
                         </a>`
                        : '<span class="text-slate-400 dark:text-slate-600 text-sm italic">N/A</span>'}
                </td>`;

                // Action
                const actionCell = `<td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                    <a href="https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(row.Name + ' ' + row.Address)}" target="_blank" class="text-blue-600 hover:text-blue-900 dark:text-blue-400 dark:hover:text-blue-300 flex items-center gap-1">
                        Map <i data-lucide="map" class="h-4 w-4"></i>
                    </a>
                </td>`;

                tr.innerHTML = checkboxCell + nameCell + addressCell + phoneCell + actionCell;
                tbody.appendChild(tr);
            });

            lucide.createIcons();

            if (document.getElementById('data-container')) {
                // Optional: Scroll to top of table on page change
                // document.getElementById('data-container').scrollIntoView({ behavior: 'smooth', block: 'start' });
            }
        }

        function exportFiltered() {
            const csv = Papa.unparse(filteredData);
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            const url = URL.createObjectURL(blob);
            link.setAttribute("href", url);
            link.setAttribute("download", "filtered_leads.csv");
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

    </script>
</body>
</html>
